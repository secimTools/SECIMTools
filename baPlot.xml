<tool id="baPlot2" name="Bland-Altman Plot (Beta)" version="2.0.0">
  <description>Create pairwise BA plots to identify outliers.</description>
  <requirements>
    <requirement type="python-module">numpy</requirement>
    <requirement type="python-module">scipy</requirement>
    <requirement type="python-module">pandas</requirement>
    <requirement type="python-module">statsmodels</requirement>
    <requirement type="python-module">matplotlib</requirement>
    <requirement type="python-module">palettable</requirement>
  </requirements>
  <command interpreter="python">baPlot.py
      --input $input
      --design $design
      --ID $uniqID
      --figure $ba_plots
      --flag_dist $outlier_dist_plots
      --flag_sample $flag_sample
      --flag_feature $flag_feature
      --resid_cutoff $resid_cutoff
      --sample_flag_cutoff $sample_cutoff
      --feature_flag_cutoff $feature_cutoff

      #if $group
          --group $group

          #if $processOnly:
            --process_only $processOnly
          #end if
      #end if

  </command>
  <inputs>
    <param name="input" type="data" format="tabular" label="Wide Dataset" help="Input dataset in wide format and tab separated. If file is not tab separated see TIP below."/>
    <param name="design" type="data" format="tabular" label="Design File" help="Design file tab separated. Note you need a 'sampleID' column. If not tab separated see TIP below"/>
    <param name="uniqID" size="30" type="text" value="" label="Unique Feature ID" help="Name of the column in your Wide Dataset that has unique feature IDs."/>
    <param name="resid_cutoff" type="text" size="30" value="3" label="Outlier Cutoff" help="Residual cutoff value, this value will flag samples whose residuals are ≥ to cutoff value."/>
    <param name="sample_cutoff" type="text" size="30" value="0.2" label="Sample Flag Cutoff" help="Flag a sample as 1, if the proportion of features within a sample that are outliers exceeds this cutoff.[Number between 0-1]"/>
    <param name="feature_cutoff" type="text" size="30" value="0.05" label="Feature Flag Cutoff" help="Flag a feature, if the proportion of times this feature was identified as an outlier exceeds this cutoff.[Number between 0-1]"/>
    <param name="group" type="text" size="30"  value="" optional="true" label="Group/Treatment [Optional]" help="Name of the column in your Design File that contains group classifications."/>
    <param name="processOnly" size="30" type="text" value="" optional="true" label="Group ID [Optional]" help="Name of the group(s) that you want to process. Separate multiple groupIDs with spaces. Leave blank to process all groups. Requires the group parameter."/>
  </inputs>
  <outputs>
    <data format="pdf" name="ba_plots" />
    <data format="pdf" name="outlier_dist_plots" />
    <data format="tabular" name="flag_sample"/>
    <data format="tabular" name="flag_feature"/>
  </outputs>
  <macros>
      <import>macros.xml</import>
  </macros>
<help>

@TIP_AND_WARNING@

**What it does**

The Bland-Altman plot (BA-Plot_) is commonly used to look at the concordance of
data between pairs of samples, particularly between replicates. This script generates
BA-plots for all pairwise combinations of samples, or, if group information is
provided, for pairwise combinations within the groups.

.. _BA-Plot: http://en.wikipedia.org/wiki/Bland%E2%80%93Altman_plot

In addition to generating the BA-plots, a linear regression is fit to
identify (flag) any unusual outlying values. These flags are summarized and
used to generate distribution plots and text files for (i) each sample and for
(ii) each feature (row).

.. class:: infomark

See below for a more in depth description of the output files.


--------------------------------------------------------------------------------

**Input**

- Two input datasets are required.

    @WIDE@

    **NOTE:** The sample IDs must match the sample IDs in the Design File
    (below). Extra columns will automatically be ignored.

    @METADATA@

    **In addition to your datasets, you need to provide:**

    **Unique Feature ID**

    - The column name in your wide dataset that contains the unique IDs for
      your features. In our example dataset you would input *Feature*.

    **Outlier Cutoff – flagging values**

    - Here we use several measures to identify values that are outliers (or leverage points).

        - (1) If the magnitude of the residuals from the linear regression on
              the BA-plot exceeds the user-defined threshold, then a value is flagged
              as an outlier. This cutoff can be adjusted by the user, the default is 3.

        - (2) If a value is identified as a leverage point using Cook's D with
              a p-value cutoff of 0.5, then the value is flagged. This cannot be
              adjusted.

        - (3) If a value is identified as a leverage point using the DFFITS technique it is
              also flagged. This cannot be adjusted.

    **Sample Flag Cutoff – flagging samples**

    - This cutoff sets the level to flag a sample.

        - Using the above *Outlier Cutoff*, we identify samples that have a
          large number of outlier values. The *Sample Cutoff* is the proportion
          of values for a sample that need to be flagged for that sample to be
          flagged. The default value is 0.2, meaning that 20% of the values need
          to be flagged as outliers for the sample to be flagged as well.

    **Feature Flag Cutoff  – flagging features**

    - This cutoff sets the level to flag a feature.
    - Using the above *Outlier Cutoff*, we identify features with a large
      number of outlier values.  The *Feature Cutoff*, is the proportion of values within
      a feature that need to be flagged for the feature to be flagged. The default value
      is 0.05, meaning that 5% of the values across a feature need to be flagged as
      outliers for the feature to be flagged.

- If you only want to do within group comparisons (**suggested**) then you need
  to specify:

    @GROUP@

    **Group ID**

    - This option allows you to specify which groups to analyze (i.e., QC
      samples). Multiple group IDs can be specified by separating them with
      spaces. This option requires that **Group/Treatment** is also specified.

--------------------------------------------------------------------------------

**Output Files**

- This tool outputs 4 different files.

    **ba_plots** is a PDF of pairwise scatter plots and BA-plots.

    .. image:: ${static_path}/images/secim/ba_plot.png
        :height: 300
        :width: 600

    The left panel is a scatter plot comparing the two samples. The right
    panel is a BA-plot where the x-axis is the mean between the two samples and y-
    axis is the difference.  The solid red line is a regression line and dotted
    lines are 95% confidence intervals. Data highlighted in red are outliers as
    determined by any of the 3 criteria described above.

    **outlier_dist_plots** is a PDF of bar graphs showing the proportion of values determined to be outliers for samples (top) and features (bottom).

    .. image:: ${static_path}/images/secim/ba_plot_outlier_dist_sample.png
        :height: 300
        :width: 600

    .. image:: ${static_path}/images/secim/ba_plot_outlier_dist_feature.png
        :height: 300
        :width: 600


    **flag_sample** is a TSV containing a 0/1 outlier flag for each sample where '1' indicates that the sample was identified as an outlier. 
    If a sample is a '1', you should consider removing the sample.

    +----------+------------------------+
    | sampleID | flag_sample_BA_outlier |
    +==========+========================+
    | as101    | 0                      |
    +----------+------------------------+
    | as102    | 0                      |
    +----------+------------------------+
    | as103    | 1                      |
    +----------+------------------------+
    | ...      | ...                    |
    +----------+------------------------+


    **flag_feature** is a TSV containing a 0/1 flag for each feature where '1'  indicates that the feature was identified as an outlier. If a feature is a      '1', you should consider removing the feature.

    +----------+-------------------------+
    | Feature  | flag_feature_BA_outlier |
    +==========+=========================+
    | one      | 0                       |
    +----------+-------------------------+
    | two      | 1                       |
    +----------+-------------------------+
    | three    | 0                       |
    +----------+-------------------------+
    | four     | 0                       |
    +----------+-------------------------+
    | ...      | ...                     |
    +----------+-------------------------+


</help>
</tool>

