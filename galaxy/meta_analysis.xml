<tool id="secimtools_meta_analysis" name="Meta-Analysis" version="@WRAPPER_VERSION@">
    <description> </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
meta_analysis.py
--wide $input
--design $design
--uniqID $uniqID
--study $study
--treatment "$treatment"
--contrast $contrast
--model $model
--effectSize $effectSize
--cmMethod $cmMethod
--summary $summary
--report $report

    ]]></command>
    <inputs>
        <param name="input" type="data" format="tabular" label="Wide Dataset" help="Input your tab-separated wide format dataset. If file is not tab-separated see TIP below."/>
        <param name="design" type="data" format="tabular" label="Design File" help="Input your design file (tab-separated). Note you need a 'sampleID' column. If not tab separated see TIP below."/>
        <param name="uniqID" size="30" type="text" value="" label="Unique Feature ID" help="Name of the column in your wide dataset that contains unique feature identifiers."/>
        <param name="study" type="text" size="30" value="" label="Study" help="Name of the column in your design file that contains study information."/>
        <param name="treatment" type="text" size="30" label="Treatment/Group" help="Name of the column in your design file that specifies treatment"/>
        <param name="contrast" type="text"  size="30" label="Contrast" help="The contrast to be used for the meta-anlysis"/>
        <param name="effectSize" type="text" size="30" label="" help="Calculate the effect size"/>
        <param name="cmMethod" type="text" size="30" label="" help="The method used to compute the sampling variances, default is unbiased estimation, can be 'LS' and 'AV' etc."/>
        <param name="model" type="text" size="30" label="Model"/>
    </inputs>
    <outputs>
        <data format="tsv" name="report" label= "${tool.name} on ${on_string}: Report"  />
        <data format="csv" name="summary" label= "${tool.name} on ${on_string}: Summary"/>>
    </outputs>
    <tests>
        <test>
            <param name="input"  value="ST000006_data.tsv"/>
            <param name="design" value="ST000006_design.tsv"/>
            <param name="uniqID" value="Retention_Index" />
            <param name="group"  value="White_wine_type_and_source" />
            <output name="ba_plots"           file="ST000006_bland_altman_plot_with_group_figure.pdf" compare="sim_size" delta="10000" />
            <output name="outlier_dist_plots" file="ST000006_bland_altman_plot_with_group_flag_distribution.pdf" compare="sim_size" delta="10000" />
            <output name="flag_sample"        file="ST000006_bland_altman_plot_with_group_flag_sample.tsv" />
            <output name="flag_feature"       file="ST000006_bland_altman_plot_with_group_flag_feature.tsv" />
            <output name="prop_feature"       file="ST000006_bland_altman_plot_with_group_proportion_feature.tsv" />
            <output name="prop_sample"        file="ST000006_bland_altman_plot_with_group_proportion_sample.tsv" />
        </test>
    </tests>
    <help><![CDATA[

@TIP_AND_WARNING@

**Tool Description**

The Bland-Altman plot (BA-Plot) is used to look at the concordance of data between pairs of samples, particularly between replicates.
The script generates BA-plots for all pairwise combinations of samples.
If the Group/Treatment column and group name(s) in that column are provided, then BA-Plots are generated only for pairwise combinations within the specified Group -- group name combination.
In addition to generating the BA-plots, a linear regression fit is calculated between the values that correspond to the pair of samples to identify (flag) any unusual outlying values.
The flags produced by the regression fit are used to generate distribution plots and text files for (i) each sample (column) and for (ii) each feature (row).


--------------------------------------------------------------------------------

**Input**

    - Two input datasets are required.

@WIDE@

**NOTE:** The sample IDs must match the sample IDs in the Design File
(below). Extra columns will automatically be ignored.

@METADATA@

@UNIQID@


**Outlier Cutoff – flagging values**

- Residual cutoff value; this value will flag samples with residuals ≥ than this cutoff value.

        (1) If the magnitude of the residuals from the linear regression on the BA-plot exceeds the user-defined threshold, then a value is flagged as an outlier. This cutoff can be adjusted by the user; the default is 3.

        (2) If a value is identified as a leverage point using Cook's D with a p-value cutoff of 0.5, then the value is flagged. This cannot be adjusted.

        (3) If a value is identified as a leverage point using the DFFITS technique, it is also flagged. This cannot be adjusted.

**Sample Flag Cutoff – flagging samples**

    - Flag a sample as 1 if the proportion of features within a sample that are outliers exceeds this cutoff. [Number between 0-1].

**Feature Flag Cutoff  – flagging features**

    - Flag a feature as 1 if the proportion of times this feature was identified as an outlier exceeds this cutoff. [Number between 0-1].

@GROUP@

**Group ID**

    - Name of the group(s) that you want to process. Separate multiple groupIDs with spaces. Leave blank to process all groups. Requires the group parameter.

--------------------------------------------------------------------------------

**Output**

This tool outputs four (or five) different files depending on the input settings:
(1) a PDF file containing BA-plots and scatterplots for each pair of samples
(2) a PDF file containing histograms of the most flagged features and samples
(3) two TSV files containing flags: one for samples and one for features
(4) if a grouping variable name is specified in the input, a TSV file containing flags for each group is also generated.
(5) two TSV files containing (i) the proportion of features flagged per sample and (ii) the proportion of samples flagged per feature.
If a sample (or feature) is flagged, the user should consider removing it from further analysis.

    ]]></help>
    <expand macro="citations"/>
</tool>
